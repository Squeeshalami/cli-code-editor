### add this to a directory that's setup in your PATH to add a command to run the text editor
### replace PATH/TO/PROJECT/DIR with the path to the cli-text-editor directory
### requires uv to be installed
### 
### Usage: stext [-d|--directory <directory>] [-s|--sudo] [filename]
### -d, --directory: specify target directory (default: current directory)
### -s, --sudo: run with elevated privileges to edit protected files
### filename: optional file to open directly

#!/usr/bin/env bash

# Get the directory where this script is located (the project directory)
PROJECT_DIR=PATH/TO/PROJECT/DIR

# Get the current working directory where the script is being called from
CURRENT_DIR="$(pwd)"

# Find the full path to uv command
UV_PATH=$(which uv 2>/dev/null)
if [[ -z "$UV_PATH" ]]; then
    echo "Error: uv command not found. Please install uv first."
    exit 1
fi

# Initialize variables
TARGET_DIR="$CURRENT_DIR"
FILENAME=""
USE_SUDO=false

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--directory)
            # Check if directory argument is provided
            if [[ -n "$2" && ! "$2" =~ ^- ]]; then
                TARGET_DIR="$2"
                shift 2
            else
                echo "Error: -d/--directory requires a directory path"
                exit 1
            fi
            ;;
        -s|--sudo)
            USE_SUDO=true
            shift
            ;;
        -*)
            echo "Error: Unknown option $1"
            echo "Usage: stext [-d|--directory <directory>] [-s|--sudo] [filename]"
            exit 1
            ;;
        *)
            # If no directory flag was used and this is the first non-flag argument,
            # treat it as a filename
            if [[ -z "$FILENAME" ]]; then
                FILENAME="$1"
            else
                echo "Error: Too many arguments"
                echo "Usage: stext [-d|--directory <directory>] [-s|--sudo] [filename]"
                exit 1
            fi
            shift
            ;;
    esac
done

# Change to project directory and run with uv
cd "$PROJECT_DIR" || exit 1  # Exit if cd fails

# Run the appropriate command based on arguments
if [[ "$USE_SUDO" == true ]]; then
    echo "Running text editor with sudo privileges..."
    echo "You may be prompted for your password."
    
    if [[ -n "$FILENAME" ]]; then
        # Both directory and filename provided with sudo
        sudo -E "$UV_PATH" run app.py "$TARGET_DIR" "$FILENAME"
    else
        # Only directory provided with sudo
        sudo -E "$UV_PATH" run app.py "$TARGET_DIR"
    fi
else
    if [[ -n "$FILENAME" ]]; then
        # Both directory and filename provided
        "$UV_PATH" run app.py "$TARGET_DIR" "$FILENAME"
    else
        # Only directory provided
        "$UV_PATH" run app.py "$TARGET_DIR"
    fi
fi
